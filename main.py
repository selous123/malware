from malware_model import malwareModel as model
from load_malware import load_malware 
import sys
import argparse
import tensorflow as tf

FLAGS = None
image_height,image_width=128,128
PIXEL_NUM = image_height*image_width
NUM_CLASSES = 9
def train():

    ##prepare data
    input_data = load_malware(FLAGS.input_data_dir)

    #build the graph
    images_pl = tf.placeholder(tf.float32,shape=[FLAGS.batch_size,PIXEL_NUM],name="images")
    labels_pl = tf.placeholder(tf.float32,shape=[FLAGS.batch_size,NUM_CLASSES],name="labels")

    m = model(images_pl,labels_pl,FLAGS.learning_rate,image_height,image_width,NUM_CLASSES)
    optimize,loss= m.optimize
    prediction = m.prediction
    accuracy = m.accuracy
    summary_op = tf.summary.merge_all()
    init = tf.global_variables_initializer()
    ##build session
    session = tf.Session()
    session.run(init)
    summary_writer = tf.summary.FileWriter(FLAGS.log_dir,session.graph);
    
    ##run
    for ind in range(FLAGS.max_step):
        images,labels = input_data.train.next_batch(FLAGS.batch_size)
        _,acc_curr,loss_curr,prediction_curr = session.run([optimize,accuracy,loss,prediction],feed_dict={
            images_pl:images,
            labels_pl:labels
        })
        
        #tensorboard
        if ind%100==0:
            summary_str = session.run(summary_op, feed_dict={
                images_pl:images,
                labels_pl:labels
                })
            summary_writer.add_summary(summary_str, ind)
            summary_writer.flush()
        if ind%100==0:
            print "step:{},prediction:{},loss:{}".format(ind,acc_curr,loss_curr)

def main(_):
    if tf.gfile.Exists(FLAGS.log_dir):
        tf.gfile.DeleteRecursively(FLAGS.log_dir);
    tf.gfile.MakeDirs(FLAGS.log_dir);
    train();


if __name__=="__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument(
        "--batch_size",
        type=int,
        default=128,
        help="size of batch"
        )
    parser.add_argument(
        "--input_data_dir",
        type=str,
        default="/mnt/hgfs/ubuntu14/dataset/img/",
        help="directory of input data")
    parser.add_argument(
        "--log_dir",
        type=str,
        default="/tmp/tensorflow/malware/logs",
        help="directory of log dir"
        )
    parser.add_argument(
        "--max_step",
        type=int,
        default=100000,
        help="max step"
        )
    parser.add_argument(
        "--learning_rate",
        type = float,
        default=0.0001,
        help="learning rate"
        )

    FLAGS,unparse = parser.parse_known_args();
    #hello world
    tf.app.run(main=main,argv=[sys.argv[0]]+unparse);
